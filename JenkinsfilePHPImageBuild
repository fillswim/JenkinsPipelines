pipeline {
    agent {
        label 'builder'
    }

    options {
        skipDefaultCheckout()
    }

    stages {
        stage('Load files') {
            steps {
                echo "====== Load files ======"
                sh 'wget https://raw.githubusercontent.com/fillswim/K8SManifests/master/Lesson-06-DockerImage/DockerfileUbuntuApache'
                sh 'wget https://raw.githubusercontent.com/fillswim/K8SManifests/master/Lesson-06-DockerImage/index.php'
            }
        }

        stage('Remove old docker images') {
            steps {
                echo "====== Remove old image ======"
                sh 'docker rmi -f fillswim/mySiteUbuntuApache:latest'
            }
        }

        stage('Docker build') {
            steps {
                echo "====== Docker build ======"
                sh 'pwd'
                sh 'docker build -t fillswim/mySiteUbuntuApache:latest -f DockerfileUbuntuApache .'
            }

        }

        stage('DockerHub login') {
            steps {
                echo "======== Docker login ========"
                sh 'cat /home/filldocker/dockerhub_token.txt | docker login --username fillswim --password-stdin'
            }
        }

        stage('Docker push') {

            environment {
                DISCRORD_WEBHOOK_LINK = credentials('Discord_webhook')
            }

            steps {
                echo "======== mySiteUbuntuApache push ========"
                sh 'docker push fillswim/mySiteUbuntuApache:latest'

                discordSend description: "mySiteUbuntuApache image has been pushed",
                link: env.BUILD_URL,
                result: currentBuild.currentResult,
                title: JOB_NAME,
                webhookURL: DISCRORD_WEBHOOK_LINK

            }
        }

    }
}